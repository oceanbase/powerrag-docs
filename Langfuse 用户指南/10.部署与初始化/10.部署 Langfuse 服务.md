# 部署 Langfuse 服务

Langfuse 服务是应用评估与观测模块的核心组件，负责采集、分析并可视化展示模型运行的观测数据。部署完成后，用户可通过 PowerRAG 控制台访问 Langfuse 控制台。

## 前提条件
+ 已完成 PowerRAG 平台部署。
+ 环境已安装并配置 Docker 或 Kubernetes。
+ 拥有网络访问权限，以便拉取镜像并启动容器。

### 系统要求
#### 硬件要求
| **资源** | **最低配置** | **推荐配置** |
| --- | --- | --- |
| CPU | 2 核 | 4 核及以上 |
| 内存 | 4 GB | 8 GB及以上 |
| 存储 | 20 GB | 50 GB及以上 |
| 网络 | 稳定连接 | - |


#### 软件要求
| **组件** | **版本要求** |
| --- | --- |
| 操作系统 | Linux (推荐 Ubuntu 20.04+ 或 CentOS 8+) |
| Docker | 20.10+ |
| Docker Compose | 2.0+ |


## 环境配置
1. 在部署目录下，创建 `.env` 环境变量文件：

```bash
cp env.template .env
```

2. 打开 `.env` 文件，根据实际环境修改环境配置。

```bash
# PostgreSQL 数据库配置
DATABASE_URL="postgresql://<用户名>:<密码>@<PostgreSQL 主机>:5432/<数据库名>"

# ClickHouse 配置
CLICKHOUSE_URL="http://<ClickHouse 主机>:8123"
CLICKHOUSE_USER="<用户名>"
CLICKHOUSE_PASSWORD="<密码>"

# Redis 配置
REDIS_HOST="<Redis 主机>"
REDIS_PORT=6379
REDIS_AUTH="<Redis 密码>"

# 服务访问配置
NEXTAUTH_URL="http://<Langfuse 服务地址>:3001"
NEXTAUTH_SECRET="<随机生成的32位密钥>"

# 镜像版本（示例）
LANGFUSE_WEB_IMAGE=powerrag-langfuse-web:v1.3.0
LANGFUSE_WORKER_IMAGE=powerrag-langfuse-worker:v1.3.0

# 镜像标签配置
LANGFUSE_WEB_IMAGE=powerrag-langfuse-web:v1.3.0
LANGFUSE_WORKER_IMAGE=powerrag-langfuse-worker:v1.3.0
```

## 部署流程
Langfuse 支持两种部署模式：

+ 完整部署（包含中间件）：自动部署 PostgreSQL、ClickHouse、Redis、MinIO 等依赖组件。
+ 应用部署（仅应用服务）：仅部署前端 Web 与后台 Worker 服务，外部需自备中间件。

Langfuse 提供两种部署方式：
+ 通过源码构建
+ 从仓库拉取镜像部署

### 方式一：通过源码构建

1. 克隆代码库。

```bash
git clone git@code.alipay.com:powerrag/langfuse.git
cd langfuse
#切换到对应的版本分支
git checkout xxx
```

2. 配置环境变量。

```bash
# 复制环境变量模板
cp env.template .env
# 编辑环境变量
# 编辑可选初始化配置，以及中间件的配置
# 编辑 登录成功后的重定向地址
# NEXTAUTH_URL="http://localhost:3001"
vim .env
```

3. 使用部署脚本部署。

```bash
# 构建所有镜像
./deploy.sh build
# 完整部署（包含中间件）
./deploy.sh start full
```

### 方式二：从仓库拉取镜像部署

1. 在 .env 里配置镜像仓库用户名和密码，从仓库 harbor.oceanbase-dev.com，项目 powerrag 拉取镜像。

```bash
HARBOR_USERNAME=your_harbor_username
HARBOR_PASSWORD=your_harbor_password
HARBOR_REGISTRY=your_harbor_host
```

2. 执行部署命令。

```bash
./deploy.sh start-with-pull full
```

## 更新与迁移
### 更新应用镜像
```bash
# 停止当前服务
./deploy.sh stop [web / worker]

# 更新环境变量中的镜像标签
vim .env
# 修改 WEB_IMAGE 和 WORKER_IMAGE

# 启动更新后的服务
./deploy.sh start  [web / worker]
```

### 执行数据迁移
Langfuse 会自动处理数据库迁移，但建议在更新前备份数据：

```bash
# 备份 PostgreSQL 数据
docker exec postgres pg_dump -U postgres postgres > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份 ClickHouse 数据
docker exec clickhouse clickhouse-client --query "BACKUP DATABASE default TO Disk('backups', 'backup_$(date +%Y%m%d_%H%M%S)')"
```

当数据迁移没有正常完成，或出现缺少表等情况时，可以手动执行迁移。

```bash
sudo docker exec langfuse-langfuse-web-1 sh -c "cd /app/packages/shared && CLICKHOUSE_CLUSTER_ENABLED=false node clickhouse/scripts/migrate.js up unclustered"
```

## 运维与监控
### 服务状态检查
```bash
# 查看所有服务状态
./deploy.sh status

# 查看特定服务日志
./deploy.sh logs langfuse-web
./deploy.sh logs langfuse-worker

# 查看服务健康状态
docker compose -f docker-compose.build.yml ps
```

### 性能监控
```bash
# 查看资源使用情况
docker stats

# 查看磁盘使用情况
docker system df

# 查看网络连接
docker network ls
```

### 日志管理
```bash
# 查看实时日志
./deploy.sh logs

# 查看特定服务日志
./deploy.sh logs langfuse-web
./deploy.sh logs langfuse-worker

# 清理旧日志
docker system prune -f
```

### 数据备份
```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/langfuse/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# 备份 PostgreSQL
docker exec postgres pg_dump -U postgres postgres > $BACKUP_DIR/postgres.sql

# 备份 ClickHouse
docker exec clickhouse clickhouse-client --query "BACKUP DATABASE default TO Disk('backups', 'backup_$(date +%Y%m%d_%H%M%S)')"

# 备份 MinIO 数据
docker cp minio:/data $BACKUP_DIR/minio_data

echo "备份完成: $BACKUP_DIR"
EOF

chmod +x backup.sh
```

## 访问地址
部署完成后，可以通过以下地址访问服务：

| **服务** | **默认访问地址** |
| --- | --- |
| Web 控制台 | [http://localhost:3001](http://localhost:3001) |
| Worker API | [http://localhost:3030](http://localhost:3030) |
| MinIO 控制台 | [http://localhost:9091](http://localhost:9091) |
| ClickHouse | [http://localhost:8123](http://localhost:8123) |
| Redis | localhost:6379 |
| PostgreSQL | localhost:5432 |


## 故障排查
### 常见问题
1. 清理初始化数据并重新初始化。

```bash
# 清理初始化数据
docker-compose exec postgres psql -U postgres -d postgres -c "DELETE FROM users WHERE email = 'admin@oceanbase.com';"

# 重启服务
./deploy.sh restart web
```

2. 服务启动失败。

```bash
# 检查 Docker 服务状态
systemctl status docker

# 检查端口占用
netstat -tlnp | grep :3001
netstat -tlnp | grep :3030

# 查看详细错误日志
./deploy.sh logs
```

3. 数据库连接问题。

```bash
# 检查数据库服务状态
docker compose -f docker-compose.build.yml ps postgres
docker compose -f docker-compose.build.yml ps clickhouse

# 测试数据库连接
docker exec postgres pg_isready -U postgres
docker exec clickhouse clickhouse-client --query "SELECT 1"
```

4. 内存不足。

```bash
# 检查内存使用
free -h
docker stats

# 清理 Docker 资源
docker system prune -a
```

5. 拉取镜像错误。 

例如，出现如下错误码时：`ERROR: failed to do request: Head "https://registry-1.docker.io/v2/library/node/manifests/22-slim": dial tcp 108.160.162.115:443: i/o timeout`，可执行以下代码进行处理。

```bash
# 检查网络连接
ping -c 3 registry-1.docker.io
# 网络连接有问题。让我们尝试几个解决方案：
# 配置Docker镜像源（如果在中国大陆）
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<EOF
{
"registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://docker.1panel.live",
    "https://docker.1ms.run",
    "https://dytt.online",
    "https://lispy.org",
    "https://docker.xiaogenban1993.com",
    "https://docker.yomansunter.com",
    "https://666860.xyz",
    "https://a.ussh.net",
    "https://hub.rat.dev",
    "https://docker.m.daocloud.io"
],
"data-root": "/data/docker",
"max-concurrent-downloads": 10,
"max-concurrent-uploads": 5
}
EOF

#重启docker 注意备份一下docker相关信息，然后再重启，防止数据丢失
sudo systemctl restart docker
```

### 日志分析
```bash
# 查看应用日志
./deploy.sh logs langfuse-web | tail -100
./deploy.sh logs langfuse-worker | tail -100

# 查看系统日志
journalctl -u docker.service -f
```



