# 结构化信息提取

本文介绍如何在 PowerRAG 社区版中使用结构化信息提取。

## 背景信息

结构化信息提取是一种将非结构化文本转化为标准化数据结构的能力。它能够识别文档中的关键实体、属性和关系，并以机器可读的格式（如 JSON）输出结果，从而让原本依赖人工阅读和检索的内容实现自动化处理与分析。

在 PowerRAG 社区版中，结构化信息提取基于 LangExtract 能力实现。通过该功能，用户可以在导入文档时自动提取关键信息，并在后续查询、筛选或问答过程中将这些结构化结果作为高精度检索条件使用。

### 适用场景

结构化信息提取适用于需要从大量文档中快速提取、索引和分析信息的场景，例如：

* **法律与合规**：自动识别合同编号、签署方、条款、金额、法条引用等关键信息。
* **金融与风控**：抽取报告中的指标、交易记录、信用信息等字段，用于监控与建模。
* **政府与企业档案**：将政策文件、公告或会议纪要转化为结构化记录，便于后续检索。
* **内容管理与知识检索**：在大规模知识库中按元数据筛选文档，支持“基于标签”的问答。

通过结构化信息提取，用户可以快速构建领域化信息抽取模板，并通过提示词优化与反馈机制不断提升模型的抽取精度和稳定性。

## 操作步骤

本文以法律文书的结构化信息提取为例，介绍从配置智能体到查看最终结果的完整流程。

### 步骤一：创建智能体并配置

1. 在 PowerRAG 社区版控制台选择 **智能体** 模块。
2. 在页面右上角选择 **创建智能体** > **从模板创建**，并在模板列表中选择 **Ingestion Pipeline** > **编排复杂的 Ingestion Pipeline**。
3. 在生成的工作流中找到 **Generate Metadata** 节点，单击进入配置框。
4. 完成如下配置。

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/langextract/1.png)

    * **flow.extractionType**：设置为 `flow.extractionType.langextract`。
    * **结果目的地**：选择 **元数据**。
    * **flow.promptDescription**：编写结构化信息提取的需求描述，可参考如下示例。

      ```plain
      从提供的法律文本中提取以下信息：
      - 合同编号（contract_number）
      - 签订日期（sign_date）
      - 合同双方（parties）
      - 合同金额（amount）
      - 关键条款（key_terms）
      - 法条引用（legal_references）
      - 案件编号（case_number）
      - 当事人（litigants）
      - 案由（case_type）
      - 判决结果（judgment）

      要求：
      - extraction_text 必须是输入文本中的原文片段，不得改写或缩写；
      - 每个实体不得与其他实体重叠；
      - 按照在文本中出现的顺序提取；
      - 为每个提取项提供 attributes 字段，例如：
        * parties: {"role": "甲方" 或 "乙方" 或 "原告" 或 "被告"}
        * key_terms: {"type": "违约责任" 或 "争议解决" 等}
        * legal_references: {"law_type": "法律" 或 "行政法规" 等}
      ```

    * **示例**：提供示例输出，可参考如下示例。

      ```json
      {
        "extractions": [
          {
            "extraction_class": "contract_number",
            "extraction_text": "HT2024001"
          },
          {
            "extraction_class": "sign_date",
            "extraction_text": "2024-03-15"
          },
          {
            "attributes": {
              "role": "甲方"
            },
            "extraction_class": "parties",
            "extraction_text": "北京科技有限公司"
          },
          {
            "attributes": {
              "role": "乙方"
            },
            "extraction_class": "parties",
            "extraction_text": "上海软件股份有限公司"
          },
          {
            "extraction_class": "amount",
            "extraction_text": "人民币120万元"
          },
          {
            "attributes": {
              "law_type": "法律"
            },
            "extraction_class": "legal_references",
            "extraction_text": "《中华人民共和国合同法》第三十九条"
          },
          {
            "attributes": {
              "type": "违约责任"
            },
            "extraction_class": "key_terms",
            "extraction_text": "如乙方延期交付超过30天，需支付合同总金额10%的违约金"
          },
          {
            "attributes": {
              "type": "争议解决"
            },
            "extraction_class": "key_terms",
            "extraction_text": "提交北京仲裁委员会仲裁"
          }
        ],
        "text": "编号为HT2024001的《软件开发服务合同》于2024年3月15日签订。甲方：北京科技有限公司，乙方：上海软件股份有限公司。合同总金额为人民币120万元。根据《中华人民共和国合同法》第三十九条，双方约定：如乙方延期交付超过30天，需支付合同总金额10%的违约金。争议解决方式：提交北京仲裁委员会仲裁。"
      }
      ```

5. 按需进行工作流编排后，保存智能体。具体工作流的编排操作，请参见 [RAGFlow 说明文档](https://ragflow.io/docs/dev/agent_introduction)。

### 步骤二：创建知识库并配置

1. 在 **知识库** 模块中，单击 **创建知识库**。
2. 在弹窗中按需依次输入知识库名称，选择嵌入模型后，在 **Ingestion pipeline** 下选择 **选择pipeline**，然后在下拉框中选择刚刚创建的 Pipeline，并保存。

    <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/langextract/2.png" width="600">

3. 按需进行知识库配置。具体操作，请参见 [RAGFlow Datasets 说明文档](https://ragflow.io/docs/dev/configure_knowledge_base)。
4. 上传待提取的文档文件并完成解析。

### 步骤三：创建聊天并配置

1. 在 **聊天** 模块中新建会话。
2. 在会话的聊天设置中，进行如下配置
    1. 知识库：选择上一步中创建的知识库。
    2. 元数据：设置为 **自动**。
    3. 其他参数可根据 [RAGFlow Chat 说明文档](https://ragflow.io/docs/dev/category/chat)按需配置。

### 步骤四：查看提取效果

完成配置后，您可以在当前页面通过自然语言查询验证提取结果。例如，输入查询：“查找合同金额在 80–90 万元之间的技术咨询服务合同”。

* 当启用元数据功能时，系统可根据已提取的结构化信息直接返回匹配结果。

  <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/langextract/3.png" width="800">

* 若禁用元数据，则因无法访问结构化字段，查询将不返回结果。  

  <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/langextract/4.png" width="800">

## API 接口使用说明

PowerRAG 同时也提供对应的 API，允许用户通过接口调用，从文本、URL 或多个文档中提取结构化信息。该接口可与其他系统集成，支持自动化任务处理和批量数据提取。本节将介绍如何通过 API 提交结构化提取任务，以及如何查询任务状态。

### 认证方式

所有接口均需使用 **Bearer Token** 认证方式。Token 通过 RAGFlow 提供的 API Key 获取。

```plain
Authorization: Bearer ragflow-<your-api-key>
```

### API 列表

#### 1. 提交结构化提取任务

* **接口**：`POST /api/v1/powerrag/struct_extract/submit`
* **认证**：需要 API Key
* **描述**：该接口用于提交一个结构化提取任务，支持从文本、URL 或多个文档中提取结构化信息。任务提交后返回 `task_id`，用户可以通过该 `task_id` 查询任务状态和提取结果。

##### 请求参数

###### 必填参数

| **参数** | **类型** | **说明** |
| --- | --- | --- |
| `text_or_documents` | string | array | 待提取的文本内容。支持两种格式：<ul><li>**字符串格式**：直接提供文本内容或 URL（当`fetch_urls=true`时）。</li><li>**数组格式**：多文档提取，每个文档包含：<ul><li>`text`（string, **必填**）：文档文本内容</li><li>`document_id`（string, **可选**）：文档 ID，未提供时自动生成</li><li>`additional_context`（string, **可选**）：文档的额外上下文信息</li></ul></li></ul> |
| `prompt_description` | string | 提取任务的描述，说明需要提取哪些类型的信息。 |
| `examples` | array | 示例数组，至少包含一个示例，每个示例包含：<ul><li>`text`（string）：示例文本</li><li>`extractions`（array）：提取结果数组，每个提取项包含：<ul><li>`extraction_class`（string）：提取类别（如 "name", "location", "date" 等）</li><li>`extraction_text`（string）：提取的文本内容（必须是原文片段）</li><li>`attributes`（object, **可选**）：提取项的属性信息</li></ul></li></ul> |

###### 可选参数

| **参数** | **类型** | **默认值** | **说明** |
| --- | --- | --- | --- |
| `fetch_urls` | boolean | false | 当`text_or_documents`为 URL 时，是否自动获取 URL 内容。 |
| `max_char_buffer` | integer | 1000 | 字符缓冲区大小。 |
| `temperature` | float | 无 | LLM 温度参数，控制输出的随机性，值越大，输出越随机。 |
| `extraction_passes` | integer | 1 | 提取轮次，默认 1。多次提取可提高准确性。 |
| `additional_context` | string | 无 | 全局额外上下文信息，提供给模型参考。 |
| `prompt_validation_level` | string | "WARNING" | 提示验证级别，决定如何处理不符合提示格式的内容。 |
| `prompt_validation_strict` | boolean | false | 是否严格验证提示，默认关闭。 |
| `resolver_params` | object | 无 | 解析器参数：<ul><li>`enable_fuzzy_alignment`（boolean）：是否启用模糊对齐</li><li>`fuzzy_alignment_threshold`（float）：模糊对齐阈值</li></ul> |
| `model_parameters` | object | 无 | 模型参数：<ul><li>`max_tokens`（integer）：最大 token 数</li></ul> |
| `timeout` | integer | 无 | 任务超时时间，单位秒。 |


##### 请求示例

###### 示例 1：解析单个文本

从单个文本中提取姓名、地点和日期信息：

```bash
curl -X POST "http://xxx.xxx.xxx.xxx:xxxx/api/v1/powerrag/struct_extract/submit" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ragflow-A2MzxxxxxxxxMDAxNj" \
  -d '{
    "text_or_documents": "John attended a conference in New York on January 1, 2024. Sarah will visit Paris on March 15, 2024.",
    "prompt_description": "Extract names, locations, and dates from the text.",
    "examples": [
      {
        "text": "John attended a conference in New York on January 1, 2024.",
        "extractions": [
          {
            "extraction_class": "name",
            "extraction_text": "John"
          },
          {
            "extraction_class": "location",
            "extraction_text": "New York"
          },
          {
            "extraction_class": "date",
            "extraction_text": "January 1, 2024"
          }
        ]
      }
    ]
  }'
```

###### 示例 2：从 URL 提取

从指定 URL 获取内容并提取信息：

```bash
curl -X POST "http://xxx.xxx.xxx.xxx:xxxx/api/v1/powerrag/struct_extract/submit" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ragflow-A2MzxxxxxxxxMDAxNj" \
  -d '{
    "text_or_documents": "http://xxx.xxx.xxx.xxx:8888/powerrag/wget-log",
    "prompt_description": "Extract names, locations, and dates from the text.",
    "examples": [
      {
        "text": "John attended a conference in New York on January 1, 2024.",
        "extractions": [
          {
            "extraction_class": "name",
            "extraction_text": "John"
          },
          {
            "extraction_class": "location",
            "extraction_text": "New York"
          },
          {
            "extraction_class": "date",
            "extraction_text": "January 1, 2024"
          }
        ]
      }
    ],
    "fetch_urls": true
  }'
```

###### 示例 3：多文档提取

从多个临床病历文档中提取患者姓名、疾病名称和用药信息，并使用 `attributes` 字段进行分类：

```bash
curl -X POST "http://xxx.xxx.xxx.xxx:xxxx/api/v1/powerrag/struct_extract/submit" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ragflow-A2MzxxxxxxxxMDAxNj" \
  -d '{
    "text_or_documents": [
      {
        "text": "患者韩立，男性，68岁，因反复头晕就诊。既往有脑梗死病史，现服用氯吡格雷和瑞舒伐他汀。",
        "document_id": "doc1"
      },
      {
        "text": "患者南宫婉，女性，54岁，确诊乳腺癌并接受化疗，现服用来曲唑和地舒单抗。",
        "document_id": "doc2"
      }
    ],
    "prompt_description": "从临床病历中提取患者姓名、疾病名称和用药信息。为每个提取项提供 `attributes` 字段。",
    "examples": [
      {
        "text": "患者王林，2型糖尿病患者，长期口服二甲双胍。",
        "extractions": [
          {
            "extraction_class": "name",
            "extraction_text": "王林"
          },
          {
            "attributes": {"category": "diagnosis"},
            "extraction_class": "disease",
            "extraction_text": "2型糖尿病"
          },
          {
            "attributes": {"category": "treatment"},
            "extraction_class": "medication",
            "extraction_text": "二甲双胍"
          }
        ]
      }
    ]
  }'
```

##### 响应格式

###### 成功响应 (200)

```json
{
    "code": 0,
    "data": {
        "task_id": "262134e2-6b10-4c6b-972d-c4cb66b21b16"
    },
    "message": "Task submitted successfully"
}
```

###### 错误响应

* **400**: 参数错误
* **503**: 服务器繁忙
* **500**: 服务器内部错误

#### 2. 查询任务状态

* **接口**：`GET /api/v1/powerrag/struct_extract/status/<task_id>`
* **认证**：需要 API Key
* **描述**：查询已提交的结构化提取任务的状态和结果。

##### 请求参数

| **参数** | **类型** | **说明** |
| --- | --- | --- |
| `task_id` | string | 提交任务后返回的任务 ID |


##### 请求示例

```bash
curl -X GET "http://xxx.xxx.xxx.xxx:xxxx/api/v1/powerrag/struct_extract/status/262134e2-6b10-4c6b-972d-c4cb66b21b16" \
  -H "Authorization: Bearer ragflow-A2MzxxxxxxxxMDAxNj"
```

##### 响应格式

###### 成功响应 (200)

```json
{
    "code": 0,
    "data": {
        "task_id": "262134e2-6b10-4c6b-972d-c4cb66b21b16",
        "status": "success",
        "created_at": "2025-01-01T00:00:00",
        "updated_at": "2025-01-01T00:00:00",
        "result": {
            "extractions": [
                {
                    "extraction_class": "name",
                    "extraction_text": "John",
                    "document_id": "doc1"
                },
                {
                    "extraction_class": "location",
                    "extraction_text": "New York",
                    "document_id": "doc1"
                }
            ]
        }
    },
    "message": "success"
}
```

响应字段说明：

| **字段** | **类型** | **说明** |
| --- | --- | --- |
| `task_id` | string | 任务 ID，用户提交任务后返回的唯一标识符 |
| `status` | string | 任务的当前状态，包括：<ul><li>`pending`：任务已提交，等待处理</li><li>`processing`：任务正在处理中</li><li>`success`：任务成功处理，结果可通过 `result` 字段获取</li><li>`failed`：任务处理失败，错误信息通过 `error` 字段返回</li><li>`not_found`：任务未找到，返回 404 错误</li></ul> |
| `created_at` | string | 任务创建时间，ISO 8601 格式 |
| `updated_at` | string | 任务更新时间，ISO 8601 格式 |
| `result` | object | 当任务成功时返回，包含提取的结构化结果 |
| `extractions` | array | 提取结果数组，包含每个提取项的信息：<ul><li>`extraction_class`: 提取类别</li><li>`extraction_text`: 提取的文本内容</li><li>`document_id`: 文档 ID（多文档提取时）</li><li>`attributes`: 提取项属性（如果提供）</li></ul> |
| `error` | string | 错误信息，任务失败时返回 |


###### 错误响应

* **404**：任务未找到
* **500**：服务器处理失败



