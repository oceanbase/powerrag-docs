# 用户追踪（User Tracking）

用户追踪功能可帮助您从全局和单个用户的维度分析应用的使用情况。在 PowerRAG 中，您可以通过在创建 Trace 时传入唯一的用户标识 userId，将 Trace 与特定用户关联，所有包含相同 userId 的 Trace 会自动归属于同一用户。userId 可以是用户名、邮箱，或任何可唯一标识用户的字符串。该参数为可选项，但推荐使用，以便获得更细粒度的可观测性数据。

## 使用方法
### Python SDK
+ 使用装饰器 @observe()

```python
from langfuse import observe, get_client

langfuse = get_client()

@observe()
def process_user_request(user_query):
    # 为当前 Trace 添加 user_id
    langfuse.update_current_trace(user_id="user_12345")

    # ... 处理逻辑 ...
    return result
```

+ 直接创建 Span

```python
from langfuse import get_client

langfuse = get_client()

# 在创建根 Span 时通过 update_trace 设置 user_id
with langfuse.start_as_current_span(
    name="process-user-request"
) as root_span:
    # 为 Trace 添加 user_id
    root_span.update_trace(user_id="user_12345")

    # 该 Trace 下的所有 Span 都会关联到该用户
    with root_span.start_as_current_generation(
        name="generate-response",
        model="gpt-4o"
    ) as gen:
        # ... 生成响应 ...
        pass
```

+ 无需直接引用 Span 时更新用户信息

```python
with langfuse.start_as_current_span(name="handle-user-interaction"):
    # 为当前 Trace 添加 user_id
    langfuse.update_current_trace(user_id="user_12345")
```

### JS/TS SDK
+ 使用上下文管理器

```typescript
import {
  startActiveObservation,
  startObservation,
  updateActiveTrace,
} from "@langfuse/tracing";

await startActiveObservation("context-manager", async (span) => {
  span.update({
    input: { query: "What is the capital of France?" },
  });

  // 为 Trace 设置 userId
  updateActiveTrace({
    userId: "user-123",
  });
});
```

+ 使用 observe 包装函数

```typescript
import { observe, updateActiveTrace } from "@langfuse/tracing";

// 原始函数
async function fetchData(source: string) {
  // 为 Trace 设置 userId
  updateActiveTrace({
    userId: "user-123",
  });

  // ... 获取数据逻辑 ...
  return { data: `some data from ${source}` };
}

// 使用 observe 包装以启用追踪
const tracedFetchData = observe(fetchData, {
  name: "observe-wrapper",
});

const result = await tracedFetchData("API");
```

+ 手动创建 Span

```typescript
import { startObservation } from "@langfuse/tracing";

const span = startObservation("manual-observation", {
  input: { query: "What is the capital of France?" },
});

// 为 Trace 设置 userId
span.updateTrace({
  userId: "user-123",
});

span.update({ output: "Paris" }).end();
```

## 查看所有用户
用户列表视图展示了所有被追踪到的用户。您可以根据整体 Token 使用量、Trace 数量以及用户反馈进行筛选和分组分析。

## 查看单个用户
单个用户视图提供了更细粒度的分析能力。您可以查看该用户的聚合指标、所有 Trace 记录及其反馈信息，帮助您了解模型在不同用户场景下的表现。

