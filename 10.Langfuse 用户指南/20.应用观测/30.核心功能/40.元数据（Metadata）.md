# 元数据（Metadata）

在可观测性系统中，可以为 Trace（调用链）和 Observation（观测点）添加元数据，以帮助你更好地了解用户、应用和实验行为。元数据以任意 JSON 形式添加到 Trace 中，用于补充上下文信息。元数据更新时，会根据顶层键（top-level key）进行合并。建议在埋点逻辑中避免对相同键进行多次写入，否则可能导致不确定行为。

## 使用方法
### Python SDK
+ 使用 @observe() 装饰器添加元数据

```python
from langfuse import observe, get_client

langfuse = get_client()

@observe()
def process_data():
    # 获取客户端实例，更新当前 trace 的元数据

    # 在 trace 级别添加元数据
    langfuse.update_current_trace(
        metadata={"source": "api", "version": "1.2.3"}
    )

    # 在当前 span 级别添加元数据
    langfuse.update_current_span(
        metadata={"processing_stage": "initial"}
    )

    # 处理数据逻辑...
    return result
```

+ 直接创建 Span 并添加元数据

```python
from langfuse import get_client

langfuse = get_client()

# 在 trace 级别添加元数据
with langfuse.start_as_current_span(
    name="process-request"
) as root_span:
    # 向 trace 添加元数据
    root_span.update_trace(metadata={"request_id": "req_12345"})

    # 向当前 span 添加元数据
    root_span.update(metadata={"stage": "parsing"})

    # 创建带有元数据的子 span
    with root_span.start_as_current_generation(
        name="generate-response",
        model="gpt-4o",
        metadata={"temperature": 0.7, "max_tokens": 1000}
    ) as gen:
        # 如有需要，可在后续更新元数据
        gen.update(metadata={"completion_type": "creative"})
```

+ 多次更新实体以新增新的元数据键 

<main id="notice" type='notice'>
    <h4>注意</h4>
    <p>建议不要对同一顶层键进行重复写入，否则会产生不确定结果。</p>
</main>

```python
with langfuse.start_as_current_span(name="operation") as span:
# 第一次写入
span.update(metadata={"status": "started"})

# 新增键，将与之前的元数据合并
span.update(metadata={"error": "Failed to process"})

# 最终元数据为 {"status": "started", "error": "Failed to process"}
```

### JS/TS SDK
+ 使用上下文管理器添加元数据

```typescript
import {
  startActiveObservation,
  startObservation,
  updateActiveTrace,
} from "@langfuse/tracing";

await startActiveObservation("context-manager", async (span) => {
  // 为 observation 添加元数据
  span.update({
    input: { query: "What is the capital of France?" },
  });

  // 为 trace 添加元数据
  updateActiveTrace({
    metadata: { key: "value" },
  });
});
```

+ 使用 observe 包装器添加元数据

```typescript
import {
  observe,
  updateActiveTrace,
  updateActiveObservation,
} from "@langfuse/tracing";

// 已有函数
async function fetchData(source: string) {
  // 为 observation 添加元数据
  updateActiveObservation({
    metadata: { key: "value" },
  });

  // 为 trace 添加元数据
  updateActiveTrace({
    metadata: { key: "value" },
  });

  // ... 数据获取逻辑
  return { data: `some data from ${source}` };
}

// 使用 observe 包装函数进行追踪
const tracedFetchData = observe(fetchData, {
  name: "observe-wrapper",
});

const result = await tracedFetchData("API");
```

+ 手动创建 Span 并添加元数据

```typescript
import { startObservation } from "@langfuse/tracing";

const span = startObservation("manual-observation", {
  input: { query: "What is the capital of France?" },
  metadata: { key: "value" },
});

span.updateTrace({
  metadata: { key: "value" },
});

span.update({ output: "Paris" }).end();
```

