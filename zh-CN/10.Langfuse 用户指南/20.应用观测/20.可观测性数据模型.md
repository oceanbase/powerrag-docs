# 可观测性数据模型

在 PowerRAG 中，调用链追踪（Tracing） 是实现可观测性的基础机制。它通过记录和分析大模型（LLM）应用的执行过程，帮助开发者了解系统的运行状态、性能瓶颈和模型行为。  

PowerRAG 的数据模型参考了 OpenTelemetry 的设计理念，并结合大模型应用的特性进行了扩展，使其能够完整刻画一次模型交互的全过程。

## Trace 与 Observation
### Trace（调用链）
一个 Trace 通常表示一次完整的请求或操作。它包含函数或任务的整体输入输出信息，以及相关的上下文元数据（例如用户标识、会话 ID、标签、请求来源等）。

在 PowerRAG 中，Trace 是所有观测数据的顶层结构，用于统一表示一次完整的模型调用、Agent 执行或应用请求。

### Observation（观测单元）
一个 Trace 可以包含多个 Observation，用于记录执行过程中的各个步骤。通常，一个 Observation 对应于应用中的一次具体调用或执行节点，例如模型生成、工具调用或上下文检索等。

#### 嵌套结构（Nesting）
Observations 支持嵌套结构。您可以手动创建嵌套关系，也可以利用 OpenTelemetry 的上下文自动传播机制自动实现。这种嵌套结构能够清晰反映调用链的层级关系，例如一个主请求中包含多个模型调用与工具调用。

#### Observation 类型
PowerRAG 支持多种适用于 LLM 应用场景的 Observation 类型，用于更精确地描述不同执行阶段：

| **类型** | **说明** |
| --- | --- |
| event | 最基础的事件单位，用于记录离散事件（如状态变更、触发点等）。 |
| span | 表示一个有明确起止时间的工作单元（unit of work），用于衡量执行耗时。 |
| generation | 记录大模型生成任务的详细信息，包括 Prompt、Token 使用量、延迟和成本。 |
| agent | 表示智能体（Agent）的决策与流程控制节点，可包含工具调用、模型推理等操作。 |
| tool | 表示工具调用，如外部 API 调用（例如天气服务或检索工具）。 |
| chain | 表示应用步骤之间的关联，如从检索模块到模型调用的数据传递链路。 |
| retriever | 表示数据检索操作，如向量库查询或数据库访问。 |
| evaluator | 表示用于评估模型输出质量、相关性或正确性的评估函数。 |
| embedding | 表示生成 Embedding 向量的调用过程，包含模型、Token 使用量与成本信息。 |
| guardrail | 表示安全防护组件，用于识别并防止不良内容或越狱攻击（jailbreak）。 |


通过这些类型，开发者可以构建出完整的多层调用链结构，精准分析应用的执行逻辑和模型表现。

## Session（会话）
多个 Trace 可以归属于同一个 Session（会话）。会话用于聚合属于同一用户交互或上下文的多次请求。例如：

+ 聊天型应用中的一个对话线程
+ 连续问答中的多轮调用
+ 同一任务流程中的多个模型调用

通过 Session，PowerRAG 可以帮助您在宏观层面分析模型在一次完整交互中的整体表现。

## Score（评分与评估）
Score 是 PowerRAG 数据模型中用于量化评估 Trace、Observation、Session 或数据集运行结果的通用对象。Score 可以是 数值型（numeric）、分类型（categorical） 或 布尔型（boolean），并支持灵活的配置与验证。典型特征如下：

+ 可绑定到 Trace、Session 或数据集运行（Dataset Run）中之一。
+ Trace 级别的 Score 可进一步关联到某个具体的 Observation（可选）。
+ 支持添加注释（comments）以提供上下文说明。
+ 可通过预定义的评分配置（Score Configuration Schema）进行验证。

常见使用场景包括：

| **场景** | **使用示例** |
| --- | --- |
| Session 级评分 | 对整个多轮对话的连贯性、相关性或体验进行综合评价。 |
| Trace 级评分 | 对单次模型输出的准确性或合理性进行评估。 |
| Dataset Run 级评分 | 对整个数据集运行的总体效果进行统计，如精准率（Precision）、召回率（Recall）、F1-score 等。 |


通过 Score 机制，PowerRAG 不仅能够记录执行数据，还能为模型优化与效果评估提供可量化指标。

