# Trace ID and distributed tracing

PowerRAG supports using custom trace IDs (such as messageId, traceId, correlationId) in the system to implement distributed tracing and associate and search trace links across services.

By default, PowerRAG assigns random IDs (such as uuid, cuid) to all recorded events. For OpenTelemetry-based SDKs, PowerRAG assigns random 32-character hexadecimal strings as trace IDs and 16-character hexadecimal strings as observation IDs.

## Data model

In PowerRAG, trace ID characteristics are as follows:

+ Must be unique within the same project
+ Used to identify and associate observations belonging to the same trace
+ Can be used for cross-service distributed tracing
+ Supports upsert operations (create or update based on ID)
+ For OpenTelemetry-based SDKs:
    - Trace ID is a 32-character lowercase hexadecimal string
    - Observation ID is a 16-character lowercase hexadecimal string

## How to use

### Python SDK

Python SDK uses W3C Trace Context format IDs by default:

+ Trace ID: 32-character lowercase hexadecimal string
+ Observation (span) ID: 16-character lowercase hexadecimal string

#### Using decorator to define custom trace ID

```python
from langfuse import observe, get_client
import uuid

@observe()
def process_user_request(user_id, request_data):
    # Function logic
    pass

# Pass custom trace ID via keyword argument
external_trace_id = "custom-" + str(uuid.uuid4())

# Generate consistent trace ID based on same input
langfuse = get_client()
trace_id = langfuse.create_trace_id(seed=external_trace_id)  # 32-character lowercase hexadecimal string, deterministically generated based on seed

process_user_request(
    user_id="user_123",
    request_data={"query": "hello"},
    langfuse_trace_id=trace_id
)
```

#### Generating deterministic trace IDs

You can generate deterministic trace IDs from any string using `create_trace_id()`:

```python
from langfuse import get_client

langfuse = get_client()

# Generate deterministic trace ID from external ID
external_id = "request_12345"
trace_id = langfuse.create_trace_id(seed=external_id)

# Use this trace ID in span
with langfuse.start_as_current_span(
    name="process-request",
    trace_context={"trace_id": trace_id}
) as span:
    # Code logic
    pass
```

#### Manually creating span with custom trace context

```python
from langfuse import get_client

langfuse = get_client()

# Specify existing trace ID via trace_context parameter
with langfuse.start_as_current_span(
    name="my-operation",
    trace_context={
        "trace_id": "abcdef1234567890abcdef1234567890",  # Must be 32-character hexadecimal string
        "parent_span_id": "fedcba0987654321"  # Optional, 16-character hexadecimal string
    }
) as span:
    print(f"This span has trace_id: {span.trace_id}")
    # Code logic
```

#### Accessing current trace ID

```python
from langfuse import get_client

langfuse = get_client()

with langfuse.start_as_current_span(name="outer-operation") as span:
    # Get current span's trace ID
    current_trace_id = langfuse.get_current_trace_id()
    current_span_id = langfuse.get_current_observation_id()

    print(f"Current trace ID: {current_trace_id}")
```

### JS/TS SDK

#### Getting current trace ID

You can get the currently active trace ID through the `getActiveTraceId` method:

```typescript
import { startObservation, getActiveTraceId } from "@langfuse/tracing";

await startObservation("run", async (span) => {
  const traceId = getActiveTraceId();
  console.log(`Current trace ID: ${traceId}`);
});
```

#### Generating deterministic trace ID

When starting a new trace with a specified traceId, you must also provide an arbitrary parentSpanId as a placeholder for the parent observation. The parent span does not actually exist and is only used to inherit the trace ID, so its value only needs to be a valid 16-character hexadecimal string. You can generate deterministic trace IDs from any string using `createTraceId` to associate traces with IDs in external systems (such as ticket systems).

```typescript
import { createTraceId, startObservation } from "@langfuse/tracing";

const externalId = "support-ticket-54321";

// Generate deterministic traceId from external ID
const langfuseTraceId = await createTraceId(externalId);

// Start new trace using this traceId
const rootSpan = startObservation(
  "process-ticket",
  {},
  {
    parentSpanContext: {
      traceId: langfuseTraceId,
      spanId: "0123456789abcdef", // Valid 16-character hexadecimal string; parent span does not actually exist, only used to inherit trace ID
      traceFlags: 1, // Mark this trace as sampled
    },
  }
);

// Later, you can regenerate the same traceId based on the same externalId for scoring or data queries
const scoringTraceId = await createTraceId(externalId);
// scoringTraceId will be consistent with langfuseTraceId

```

When `parentSpanContext` is set, the newly created span will no longer inherit the currently active span context but will independently form a new trace link.

