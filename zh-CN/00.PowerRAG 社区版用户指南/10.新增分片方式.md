# 新增分片方式

PowerRAG 在 RAGFlow 的原有分片机制基础上，新增了三种更灵活的分片方式：**标题分片（Title）**、**正则分片（Regex）** 和 **智能分片（Smart）**。

这些分片方式可用于文档导入与解析阶段，用于控制文档块的划分粒度，提升知识检索和问答的准确性。RAGFlow 的原生分片策略在大多数场景下已能满足需求，但对于结构层次复杂、格式不统一或包含代码、表格等多种内容类型的文档，PowerRAG 提供的这三种扩展分片方式能实现更高的语义完整性与结构控制。

若需了解 RAGFlow 原生支持的分片策略，请参见 [RAGFlow 官方文档](https://ragflow.io/docs/v0.22.0/select_pdf_parser)。

## 功能入口

* 对于新增知识库，在创建知识库时可设置知识库的分片方式。

    <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/chunking/1.png" width="800">

* 对于已创建的知识库，可在配置中修改知识库的分片方式。

    <img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/chunking/2.png" width="800">

## 标题分片

### 功能说明

**标题分片（Title）** 是一种按照文档标题层级进行切分的策略。系统会根据 Markdown 或其他文档格式中的标题层次结构，将内容分割为独立的章节块。每个块从一个标题开始，直到遇到下一个同级或更高级标题时结束。

此方式可确保每个分片都代表一个逻辑完整的章节，适合对章节内容进行独立检索或展示的场景。

标题分片支持文档格式为 DOCX、DOC、PDF、Markdown、HTML。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/chunking/3.png" width="800">

### 使用场景

* **技术文档、产品手册或规范性文件**：适用于需要按章节进行逻辑切分的长篇技术文档、用户手册或产品规格说明书，能够根据标题层级清晰划分内容块，便于结构化呈现和导航。
* **含有明确层级结构的长篇文档**：对于层级分明、内容丰富的长篇文档（如标准、指南等），标题分片能够确保每个章节或子章节保持独立性，便于用户查阅和导航。
* **需要基于目录或章节级导航的知识库**：如果文档需要支持目录式导航或章节级检索（如在线文档库、知识管理系统等），标题分片能提供清晰的分段结构，提升检索效率。
* **需要保持标题与内容关联性的文档**：适用于文档中各个标题与其下内容密切相关的情况，标题分片能够确保每个切片保持完整的上下文，同时保留标题的层级信息。

### 配置方法

在创建知识库或导入文档时，选择分片方式为 `Title`，并可通过以下参数设置切分层级：

* **标题级别**：选择用于切分文档的最大标题级别（H1-H6），更高级别包含所有更低级别。
* **文本分段标识符**：文本分段标识符，支持多字符分隔符，用两个反引号（``）包裹。

### 示例

**输入文档：**

```plain
# 系统概述
系统采用分布式架构。

## 核心组件
包括存储引擎、调度模块和计算节点。

## 部署方式
可通过容器或物理机进行部署。
```

**配置：**

标题级别为 2。

**输出分片：**

* 块 1：

    ```plain
    # 系统概述
    系统采用分布式架构。
    ```

* 块 2：

    ```plain
    ## 核心组件
    包括存储引擎、调度模块和计算节点。

    ## 部署方式
    可通过容器或物理机进行部署。
    ```

## 正则分片

### 功能说明

**正则分片（Regex）** 允许用户使用自定义的正则表达式定义分隔符，以此灵活控制文档的切分规则。这种方式不依赖文档结构分析，适合处理非标准格式的文件或日志类数据。

正则分片支持文档格式为 DOCX、DOC、PDF、Markdown、HTML。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/chunking/4.png" width="800">

### 使用场景

* **按编号、日期或关键符号切分的合同或政策文件**：正则分片适用于需要根据特定编号、日期或符号（如条款编号、日期标记等）切分的合同文件、政策文件等，有助于按照特定格式或规则高效拆分。
* **日志文件或时间序列记录**：对于日志文件、事件记录或时间序列数据，正则分片可以根据预设的模式（如时间戳、事件标识符等）拆分文档，有效处理和归类这些连续的记录数据。
* **批量数据文件或导出报告**：适用于批量生成或导出的报告、数据文件，这些文档通常包含统一的格式或结构，正则分片能够根据文件中的特定符号或格式规则快速拆分数据块。
* **自定义格式的纯文本**：当文档格式不固定，且结构多样时，正则分片可以根据用户定义的正则表达式进行灵活切分，处理各种非标准格式的文本文件，如日志文件、配置文件等。
* **需要根据特定模式提取信息的文档**：如果需要按特定关键词、格式或符号提取文本块（如邮件记录、批注、脚本等），正则分片能够帮助从结构复杂的文档中提取关键信息并进行拆分。

### 配置方法

在创建知识库时，选择分片方式为 `Regex`，并通过以下参数进行配置：

* 正则表达式模式：用于初步分割文本单元的正则表达式。该模式定义如何在分块之前将文本分割成单元。例如，`"[.!?]+\s*"` 匹配句子结尾。
* 文本分段标识符：按指定字符拆分切片，可指定多个字符，例如换行、句号、分号等

> 说明
> 系统首先根据 **正则表达式模式** 切分文本得到初步单元；若单元过大，则根据 **文本分段标识符** 进一步拆分，避免生成过长的切片。

### 示例
**输入文档：**

```plain
1. 项目背景
本项目旨在建立统一的监控系统。

2. 系统要求
系统需支持多租户、容灾和高可用。

3. 实施计划
第一阶段部署核心节点，第二阶段扩展存储能力。
```

**配置：**

* 正则表达式模式：`[.!?]+\s*`
* 文本分段标识符：`\n。.；;！!？？`

**输出分片：**

* 块 1：

    ```plain
    1. 项目背景
    本项目旨在建立统一的监控系统。
    ```

* 块 2：

    ```plain
    2. 系统要求
    系统需支持多租户、容灾和高可用。
    ```

* 块 3：

    ```plain
    3. 实施计划
    第一阶段部署核心节点，第二阶段扩展存储能力。
    ```

## 智能分片

### 功能说明

**智能分片（Smart）** 基于文档的语义结构自动识别段落、列表、表格、代码块等内容，在保持语义完整性的前提下控制分片大小。与标题分片相比，智能分片不仅考虑标题结构，还能综合判断文档的布局特征与逻辑关系，实现更自然的语义划分。

智能分片支持文档格式为 DOCX、DOC、PDF、Markdown、HTML。

#### 工作原理

1. 系统以标题为主要分隔符，将文档划分为层级结构的内容块。每个切片会保留其所在标题及父标题信息，用于后续的上下文追溯与语义关联。
2. 系统识别文档中的段落、列表、表格、代码块和引用块，并在语义单元基础上进行智能合并与分割。对于表格和代码块，即便其长度超过建议切片大小，也不会被进一步切分，以保证内容完整性。
3. 在语义层面综合判断文本关联度与逻辑边界，输出保持上下文连续且语义完整的分片。

<img src="https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/chunking/5.png" width="800">

### 使用场景

* **包含多种元素（段落、表格、代码）的技术类文档**：适用于需要按语义分割的技术文档，尤其是文档中包含多种元素的情况（如段落、表格、代码块等）。
* **标题层级规范的文档**：智能分片利用文档中的标题层级结构进行切分，因此更适用于 Markdown 格式的文档（如 `.md` 文件）。标题层级规范的文档能更好地发挥此分片策略的优势。
* **需要兼顾语义完整性与检索精度的知识库**：适用于需要精确语义切分，同时保留文档逻辑关系的知识库。
* **初次导入文档时的通用选择**：智能分片是一个通用选择，适合初次导入文档时使用，尤其在文档结构不够规范的情况下，它能自动补充语义层面的分割。

### 示例

**输入文档：**

```plain
## 系统组件
系统由以下模块组成：
- 数据采集模块
- 任务调度模块
- 日志分析模块

| 模块 | 描述 |
|------|------|
| 数据采集模块 | 负责从外部源读取数据 |
| 日志分析模块 | 提供日志统计与可视化 |
```

**输出分片：**

* 块 1：

    ```plain
    ## 系统组件
    系统由以下模块组成：
    - 数据采集模块
    - 任务调度模块
    - 日志分析模块
    ```

* 块 2：

    ```plain
    | 模块 | 描述 |
    |------|------|
    | 数据采集模块 | 负责从外部源读取数据 |
    | 日志分析模块 | 提供日志统计与可视化 |
    ```

**智能分片的处理：**

1. **标题切分**：首先，系统会将 `## 系统组件` 作为主要分隔符进行切分，因此文档将被分割成两个部分：标题和其后内容。
2. **内容合并**：在这个例子中，段落、列表、表格等元素会被合并为一个完整的语义单元，以保持内容逻辑的连续性。
3. **表格和代码块**：表格部分由于其内容不可拆分，会被视为一个独立单元，即便它超过了建议的切片大小，也不会被拆开。

块 1 包含了标题 `## 系统组件` 和紧跟其后的段落与列表内容。标题和内容被视为一个逻辑单元，保持上下文完整；块 2 的表格部分由于不能拆分，单独作为一个切片。即便表格的内容超过了建议的切片大小，它也不会被拆分成更小的部分。

