# Deploy Bridge service

Bridge Service is a middleware layer connecting the PowerRAG platform and Langfuse Service, used to transfer observability and evaluation data between them (via SDK/API). 

After deploying Bridge Service, users can use the **Application Evaluation** and **Application Observability** features in the PowerRAG console.

## Prerequisites

Before deploying Bridge Service, ensure that the following operations have been completed:

+ Langfuse Service has been deployed and verified to be running normally.
+ **Public Key** and **Secret Key** have been created and saved in the Langfuse console.
+ Network environment is available to access Langfuse.

### System requirements

#### Hardware requirements

| **Resource** | **Minimum Configuration** |
| --- | --- |
| CPU | 2 cores |
| Memory | 4 GB (8 GB recommended) |
| Storage | 10 GB available space |
| Network | Stable connection |

#### Software requirements

| **Component** | **Version Requirements** |
| --- | --- |
| Operating System | Linux (Ubuntu 20.04+ recommended) |
| Docker | 20.10+ |
| Docker Compose | 2.0+ |
| Python | 3.11+ (if using direct run mode) |

## Environment preparation

1. Install Docker and Docker Compose.

    ```bash
    # Ubuntu/Debian
    sudo apt update
    sudo apt install docker.io docker-compose-plugin

    # Start Docker service
    sudo systemctl start docker
    sudo systemctl enable docker

    # Add user to docker group
    sudo usermod -aG docker $USER
    newgrp docker
    ```

2. Export images to create deployment package.

    ```bash
    # Use default version number (read IMAGE_TAG from .env file)
    ./export-images.sh

    # Specify version number
    ./export-images.sh v1.2.3
    ```

    The deployment package contents are as follows:

    ```bash
    langfuse-bridge-delivery-[version]/
    ├── docker-compose.yml              # Docker Compose configuration
    ├── env.template                    # Environment variable template
    ├── deploy.sh                       # Deployment script
    ├── Dockerfile.minimal              # Docker build file
    ├── User Guide.md                    # User guide
    ├── README.md                       # Project description
    ├── QUICK_START.md                  # Quick start guide
    ├── DOCKER_DEPLOYMENT.md            # Docker deployment documentation
    ├── langfuse-bridge-image.tar.gz    # Docker image file (if exists)
    ├── VERSION                         # Version information
    └── FILES.txt                       # File manifest
    ```

## Deploy service

Bridge provides two deployment methods:
+ Build from source code
+ Pull images from repository for deployment

### Method 1: Build from source code

```bash
# 1. Build images
./deploy.sh build

# 2. Start service
./deploy.sh start

# 3. Push images after testing
./deploy.sh upload

```

### Method 2: Pull images from repository for deployment

1. Configure the image repository username and password in `.env` to pull images from the repository harbor.oceanbase-dev.com, project powerrag.

    ```bash
    HARBOR_USERNAME=your_harbor_username
    HARBOR_PASSWORD=your_harbor_password
    HARBOR_REGISTRY=your_harbor_host
    ```

2. Execute the deployment command.

    ```bash
    # Pull images from Harbor repository and deploy
    ./deploy.sh start-with-pull

    # Pull images from Harbor repository, deploy and restart
    ./deploy.sh restart-with-pull
    ```

## Configure remote evaluation trigger

Before using the SDK evaluation feature triggered from the Langfuse console, you need to configure the remote evaluation trigger. For specific functions and configuration methods, please refer to the "Configure Webhook" section in [Run Evaluation via Console](../40.Application%20Evaluation/20.Benchmarking/30.Run%20Evaluation%20via%20Console.md).

When configuring the remote evaluation trigger, you need to configure the following information:

+ **Webhook URL**: `http://<Bridge service host>:9002/webhook/dataset/process-items`. Replace `<Bridge service host>` with the actual Bridge service host address.
+ **Default Payload Configuration**: Refer to the [Bridge Payload Configuration Documentation](https://github.com/oceanbase/langfuse/blob/main/BRIDGE-PAYLOAD.md#bridge-payload-%E9%85%8D%E7%BD%AE) for complete payload configuration instructions.

## Operations and monitoring

### Health check

```bash
# Check service status
curl http://localhost:9002/webhook/health

# Expected response
{
  "status": "healthy",
  "timestamp": "2025-01-XX TXX:XX:XXZ",
  "version": "1.0.0"
}
```

### Log management

```bash
# View real-time logs
docker-compose logs -f langfuse-bridge

# View last 100 lines of logs
docker-compose logs --tail=100 langfuse-bridge

# View logs for specific time period
docker-compose logs --since="2025-01-01T00:00:00" langfuse-bridge

# View error logs
docker-compose logs langfuse-bridge | grep ERROR
```

### Performance monitoring

```bash
# View container resource usage
docker stats langfuse-bridge

# View container detailed information
docker inspect langfuse-bridge

# View port occupancy
netstat -tlnp | grep 9002
```

## Troubleshooting

### Common issues

1. Container startup failure.

    ```bash
    # View startup logs
    docker-compose logs langfuse-bridge

    # Check environment variables
    docker-compose config

    # Check port occupancy
    netstat -tlnp | grep 9002

    # Check Docker service status
    systemctl status docker
    ```

2. Insufficient memory.

    ```bash
    # View memory usage
    free -h
    docker stats langfuse-bridge

    # Adjust memory limits
    # Edit docker-compose.yml
    deploy:
    resources:
        limits:
        memory: 2G
        reservations:
        memory: 1G
    ```

3. Network connection issues.

    ```bash
    # Test network connection
    curl -v http://localhost:9002/webhook/health

    # Check firewall
    sudo ufw status
    sudo firewall-cmd --list-ports

    # Check DNS resolution
    nslookup cloud.langfuse.com
    ```

4. Timeout errors.

    ```bash
    # Increase timeout
    export LANGFUSE_TIMEOUT=600
    export POWERRAG_TIMEOUT=1200
    docker-compose restart
    ```

### Debug mode

```bash
# Enable debug mode
export DEBUG=true
export LOG_LEVEL=DEBUG
docker-compose up

# Enter container for debugging
docker-compose exec langfuse-bridge bash
```

### Performance optimization

1. Concurrency configuration optimization

    ```bash
    # Adjust according to server performance
    # CPU cores * 2
    export MAX_CONCURRENT=8

    # Evaluator concurrency control
    export EVALUATOR_BATCH_SIZE=2
    export EVALUATOR_MAX_CONCURRENT=2
    export EVALUATOR_REQUEST_DELAY=15.0
    ```

2. Memory optimization

    ```bash
    # Set memory safety parameters
    export PYTHONHASHSEED=0
    export PYTHONUNBUFFERED=1
    export PYTHONMALLOC=malloc
    export MALLOC_CHECK_=0
    export PYTHONGC=1
    ```

3. Network optimization

    ```bash
    # Adjust timeout configuration
    export LANGFUSE_TIMEOUT=60    # When network is good
    export POWERRAG_TIMEOUT=300  # When network is good
    export OTLP_TIMEOUT=60
    ```

4. Log optimization

    ```yaml
    # docker-compose.yml
    services:
    langfuse-bridge:
        logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    ```

5. Resource limits

    ```yaml
    # docker-compose.yml
    services:
    langfuse-bridge:
        deploy:
        resources:
            limits:
            memory: 4G
            cpus: '2.0'
            reservations:
            memory: 2G
            cpus: '1.0'
    ```

