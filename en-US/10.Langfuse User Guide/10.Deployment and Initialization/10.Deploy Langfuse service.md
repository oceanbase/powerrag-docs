# Deploy Langfuse service

Langfuse Service is the core component of the application evaluation and observability module, responsible for collecting, analyzing, and visually displaying observability data from model runtime. After deployment, users can access the Langfuse console through the PowerRAG console.

## Prerequisites

+ PowerRAG platform deployment has been completed.
+ Docker or Kubernetes is installed and configured in the environment.
+ Network access permissions are available to pull images and start containers.

### System requirements

#### Hardware requirements

| **Resource** | **Minimum Configuration** | **Recommended Configuration** |
| --- | --- | --- |
| CPU | 2 cores | 4 cores or more |
| Memory | 4 GB | 8 GB or more |
| Storage | 20 GB | 50 GB or more |
| Network | Stable connection | - |

#### Software requirements

| **Component** | **Version Requirements** |
| --- | --- |
| Operating System | Linux (Ubuntu 20.04+ or CentOS 8+ recommended) |
| Docker | 20.10+ |
| Docker Compose | 2.0+ |

## Environment configuration

1. Create a `.env` environment variable file in the deployment directory:

```bash
cp env.template .env
```

2. Open the `.env` file and modify the environment configuration according to your actual environment.

```bash
# PostgreSQL database configuration
DATABASE_URL="postgresql://<username>:<password>@<PostgreSQL host>:5432/<database name>"

# ClickHouse configuration
CLICKHOUSE_URL="http://<ClickHouse host>:8123"
CLICKHOUSE_USER="<username>"
CLICKHOUSE_PASSWORD="<password>"

# Redis configuration
REDIS_HOST="<Redis host>"
REDIS_PORT=6379
REDIS_AUTH="<Redis password>"

# Service access configuration
NEXTAUTH_URL="http://<Langfuse service address>:3001"
NEXTAUTH_SECRET="<32-character randomly generated secret>"

# Image version (example)
LANGFUSE_WEB_IMAGE=powerrag-langfuse-web:v1.3.0
LANGFUSE_WORKER_IMAGE=powerrag-langfuse-worker:v1.3.0

# Image tag configuration
LANGFUSE_WEB_IMAGE=powerrag-langfuse-web:v1.3.0
LANGFUSE_WORKER_IMAGE=powerrag-langfuse-worker:v1.3.0
```

## Deployment procedure

Langfuse supports two deployment modes:

+ **Full deployment (including middleware)**: Automatically deploys dependent components such as PostgreSQL, ClickHouse, Redis, and MinIO.
+ **Application deployment (application services only)**: Deploys only the frontend Web and backend Worker services, with middleware provided externally.

Langfuse provides two deployment methods:
+ Build from source code
+ Pull images from repository for deployment

### Method 1: Build from source code

1. Clone the repository.

```bash
git clone git@code.alipay.com:powerrag/langfuse.git
cd langfuse
# Switch to the corresponding version branch
git checkout xxx
```

2. Configure environment variables.

```bash
# Copy environment variable template
cp env.template .env
# Edit environment variables
# Edit optional initialization configuration and middleware configuration
# Edit redirect URL after successful login
# NEXTAUTH_URL="http://localhost:3001"
vim .env
```

3. Deploy using the deployment script.

```bash
# Build all images
./deploy.sh build
# Full deployment (including middleware)
./deploy.sh start full
```

### Method 2: Pull images from repository for deployment

1. Configure the image repository username and password in `.env` to pull images from the repository harbor.oceanbase-dev.com, project powerrag.

```bash
HARBOR_USERNAME=your_harbor_username
HARBOR_PASSWORD=your_harbor_password
HARBOR_REGISTRY=your_harbor_host
```

2. Execute the deployment command.

```bash
./deploy.sh start-with-pull full
```

## Updates and migration

### Update application images

```bash
# Stop current service
./deploy.sh stop [web / worker]

# Update image tags in environment variables
vim .env
# Modify WEB_IMAGE and WORKER_IMAGE

# Start updated service
./deploy.sh start  [web / worker]
```

### Perform data migration

Langfuse automatically handles database migrations, but it is recommended to back up data before updating:

```bash
# Backup PostgreSQL data
docker exec postgres pg_dump -U postgres postgres > backup_$(date +%Y%m%d_%H%M%S).sql

# Backup ClickHouse data
docker exec clickhouse clickhouse-client --query "BACKUP DATABASE default TO Disk('backups', 'backup_$(date +%Y%m%d_%H%M%S)')"
```

When data migration does not complete normally, or when tables are missing, you can manually execute the migration.

```bash
sudo docker exec langfuse-langfuse-web-1 sh -c "cd /app/packages/shared && CLICKHOUSE_CLUSTER_ENABLED=false node clickhouse/scripts/migrate.js up unclustered"
```

## Operations and monitoring

### Service status check

```bash
# View all service status
./deploy.sh status

# View specific service logs
./deploy.sh logs langfuse-web
./deploy.sh logs langfuse-worker

# View service health status
docker compose -f docker-compose.build.yml ps
```

### Performance monitoring

```bash
# View resource usage
docker stats

# View disk usage
docker system df

# View network connections
docker network ls
```

### Log management

```bash
# View real-time logs
./deploy.sh logs

# View specific service logs
./deploy.sh logs langfuse-web
./deploy.sh logs langfuse-worker

# Clean up old logs
docker system prune -f
```

### Data backup

```bash
# Create backup script
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/langfuse/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# Backup PostgreSQL
docker exec postgres pg_dump -U postgres postgres > $BACKUP_DIR/postgres.sql

# Backup ClickHouse
docker exec clickhouse clickhouse-client --query "BACKUP DATABASE default TO Disk('backups', 'backup_$(date +%Y%m%d_%H%M%S)')"

# Backup MinIO data
docker cp minio:/data $BACKUP_DIR/minio_data

echo "Backup completed: $BACKUP_DIR"
EOF

chmod +x backup.sh
```

## Access addresses

After deployment, you can access services through the following addresses:

| **Service** | **Default Access Address** |
| --- | --- |
| Web Console | [http://localhost:3001](http://localhost:3001) |
| Worker API | [http://localhost:3030](http://localhost:3030) |
| MinIO Console | [http://localhost:9091](http://localhost:9091) |
| ClickHouse | [http://localhost:8123](http://localhost:8123) |
| Redis | localhost:6379 |
| PostgreSQL | localhost:5432 |

## Troubleshooting

### Common issues

1. Clean initialization data and reinitialize.

```bash
# Clean initialization data
docker-compose exec postgres psql -U postgres -d postgres -c "DELETE FROM users WHERE email = 'admin@oceanbase.com';"

# Restart service
./deploy.sh restart web
```

2. Service startup failure.

```bash
# Check Docker service status
systemctl status docker

# Check port occupancy
netstat -tlnp | grep :3001
netstat -tlnp | grep :3030

# View detailed error logs
./deploy.sh logs
```

3. Database connection issues.

```bash
# Check database service status
docker compose -f docker-compose.build.yml ps postgres
docker compose -f docker-compose.build.yml ps clickhouse

# Test database connection
docker exec postgres pg_isready -U postgres
docker exec clickhouse clickhouse-client --query "SELECT 1"
```

4. Insufficient memory.

```bash
# Check memory usage
free -h
docker stats

# Clean up Docker resources
docker system prune -a
```

5. Image pull errors.

For example, when encountering the following error code: `ERROR: failed to do request: Head "https://registry-1.docker.io/v2/library/node/manifests/22-slim": dial tcp 108.160.162.115:443: i/o timeout`, you can execute the following code to handle it.

```bash
# Check network connection
ping -c 3 registry-1.docker.io
# Network connection issues. Let's try several solutions:
# Configure Docker image registry (if in Chinese mainland)
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<EOF
{
"registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://registry.docker-cn.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://docker.1panel.live",
    "https://docker.1ms.run",
    "https://dytt.online",
    "https://lispy.org",
    "https://docker.xiaogenban1993.com",
    "https://docker.yomansunter.com",
    "https://666860.xyz",
    "https://a.ussh.net",
    "https://hub.rat.dev",
    "https://docker.m.daocloud.io"
],
"data-root": "/data/docker",
"max-concurrent-downloads": 10,
"max-concurrent-uploads": 5
}
EOF

# Restart docker. Note: back up docker-related information before restarting to prevent data loss
sudo systemctl restart docker
```

### Log analysis

```bash
# View application logs
./deploy.sh logs langfuse-web | tail -100
./deploy.sh logs langfuse-worker | tail -100

# View system logs
journalctl -u docker.service -f
```

