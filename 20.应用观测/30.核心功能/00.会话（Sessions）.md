# 会话（Sessions）

在大多数 LLM 应用中，一次完整的交互往往会涉及多个 Trace。PowerRAG 中的 Session（会话）功能用于将这些 Trace 归为一组，并提供该次交互的可视化 Session Replay（会话回放）。要使用此功能，只需在创建 Trace 时添加一个 sessionId 参数。所有使用相同 sessionId 的 Trace 都会自动归为同一会话。

## 使用方法
### Python SDK
+ 使用装饰器 @observe()

```python
from langfuse import observe, get_client

@observe()
def process_request():
    # 获取客户端实例
    langfuse = get_client()

    # 为当前 Trace 添加 session_id
    langfuse.update_current_trace(session_id="your-session-id")

    # ... 处理逻辑 ...
    return result
```

+ 直接创建 Span

```python
from langfuse import get_client

langfuse = get_client()

# 在创建根 Span 时设置 session_id
with langfuse.start_as_current_span(
    name="process-chat-message"
) as root_span:
    # 为 Trace 添加 session_id
    root_span.update_trace(session_id="chat-session-123")

    # 该 Trace 下的所有 Span 都属于同一个会话
    with root_span.start_as_current_generation(
        name="generate-response",
        model="gpt-4o"
    ) as gen:
        # ... 生成响应 ...
        pass
```

+ 无需直接引用 Span 时更新会话

```python
with langfuse.start_as_current_span(name="another-operation"):
    # 为当前 Trace 添加 session_id
    langfuse.update_current_trace(session_id="your-session-id")
```

### JS/TS SDK
+ 使用上下文管理器

```typescript
import {
  startActiveObservation,
  startObservation,
  updateActiveTrace,
} from "@langfuse/tracing";

await startActiveObservation("context-manager", async (span) => {
  span.update({
    input: { query: "What is the capital of France?" },
  });

  // 为 Trace 设置 sessionId
  updateActiveTrace({
    sessionId: "session-123",
  });
});
```

+ 使用 observe 包装函数

```typescript
import { observe, updateActiveTrace } from "@langfuse/tracing";

// 原始函数
async function fetchData(source: string) {
  // 为 Trace 设置 sessionId
  updateActiveTrace({
    sessionId: "session-123",
  });

  // ... 获取数据逻辑 ...
  return { data: `some data from ${source}` };
}

// 使用 observe 进行追踪
const tracedFetchData = observe(fetchData, {
  name: "observe-wrapper",
});

const result = await tracedFetchData("API");
```

+ 手动创建 Span

```typescript
import { startObservation } from "@langfuse/tracing";

const span = startObservation("manual-observation", {
  input: { query: "What is the capital of France?" },
});

// 为 Trace 设置 sessionId
span.updateTrace({
  sessionId: "session-123",
});

span.update({ output: "Paris" }).end();
```

