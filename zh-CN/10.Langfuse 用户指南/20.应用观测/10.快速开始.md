# 快速开始

本文将指导您在 Langfuse 中完成调用链（Trace）接入，帮助您快速体验可观测功能的使用流程。

## 获取 API 密钥
在开始之前，您需要先获取访问 Langfuse 的 API 密钥。若您在部署 Langfuse 时，已根据 [访问 Langfuse 并创建 API 密钥](../10.部署与初始化/20.访问%20Langfuse%20并创建%20API%20密钥.md) 获取密钥，则可跳过此步骤。

1. 登录 PowerRAG 控制台，在左侧导航栏单击 **观测** 进入 Langfuse 控制台。
2. 在左侧导航栏，单击 **设置**，然后在项目设置的 API 密钥页面创建新的 API 密钥，包括公钥（Public Key）和私钥（Secret Key）。

    ![](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/powerrag/langfuse/api-key2.png)

## 导入 Trace 数据
PowerRAG 提供了多语言 SDK 接入方式。您可以通过 Python 或 JavaScript/TypeScript SDK 将模型调用的执行过程接入追踪系统。

### 使用 Python SDK
PowerRAG 提供对 Langfuse Python SDK 的兼容支持，可用于追踪任何大模型或 Agent 调用。

1. 安装 SDK。

    ```python
    pip install langfuse
    ```

2. 配置环境变量。 在项目根目录下创建 .env 文件，并添加以下配置项：

    ```python
    LANGFUSE_SECRET_KEY = "sk-lf-..."
    LANGFUSE_PUBLIC_KEY = "pk-lf-..."
    LANGFUSE_HOST = "https://xxx"
    ```

3. 按照以下任一方式创建 Trace。
    1. 使用 @observe 装饰器（Observe Decorator） 
    
        @observe 是最简便的埋点方式，该方式适合快速集成与函数级别的追踪。它可以应用在任意函数上，自动捕获函数名、输入参数、返回值及执行时间，并在函数返回时自动结束当前 span。

        ```python
        from langfuse import observe, get_client
        
        @observe
        def my_function():
            return "Hello, world!"  # 输入/输出及耗时自动捕获
        
        my_function()
        
        # 在短生命周期应用中手动刷新事件
        langfuse = get_client()
        langfuse.flush()
        ```

    2. 使用上下文管理器（Context Managers） 
    
        上下文管理器方式更灵活，适用于对应用中不同任务块（chunk）的追踪，该方式适合复杂的工作流和需要层级可视化的追踪场景。它会在进入和退出上下文时自动处理 span 的开始与结束，并支持嵌套 span。

        ```python
        from langfuse import get_client
        
        langfuse = get_client()
        
        # 创建一个 span
        with langfuse.start_as_current_span(name="process-request") as span:
            # 业务逻辑
            span.update(output="Processing complete")
        
            # 嵌套一个生成任务（例如 LLM 调用）
            with langfuse.start_as_current_generation(name="llm-response", model="gpt-3.5-turbo") as generation:
                generation.update(output="Generated response")
        
        # 退出上下文时所有 span 自动关闭
        
        # 刷新事件
        langfuse.flush()
        ```

    3. 手动控制（Manual Observations） 
    
        如果您需要完全控制 span 的生命周期（例如异步任务或跨线程调用场景），可以使用手动方式创建和结束 span。该方式提供最高的灵活度，但需要开发者自行管理 span 的关闭逻辑。

        ```python
        from langfuse import get_client
        
        langfuse = get_client()
        
        # 手动创建 span
        span = langfuse.start_span(name="user-request")
        
        # 执行业务逻辑
        span.update(output="Request processed")
        
        # 创建子 span
        nested_span = span.start_span(name="nested-span")
        nested_span.update(output="Nested span output")
        
        # 手动结束子 span 和父 span
        nested_span.end()
        span.end()
        
        # 刷新事件
        langfuse.flush()
        ```

### 使用 JS/TS SDK
PowerRAG 同样支持使用 JavaScript 或 TypeScript SDK 将 LLM 应用纳入可观测体系。

1. 安装 SDK。

    ```bash
    npm install @langfuse/tracing
    ```

2. 添加凭据。 在项目根目录下创建 .env 文件，并确保使用如 dotenv 等包加载环境变量：

    ```bash
    LANGFUSE_SECRET_KEY = "sk-lf-..."
    LANGFUSE_PUBLIC_KEY = "pk-lf-..."
    LANGFUSE_BASE_URL = "https://xxx"
    ```

3. 初始化 OpenTelemetry。
    1. 安装 OpenTelemetry Node SDK：

        ```bash
        npm install @opentelemetry/sdk-node
        ```

    2. 创建 instrumentation.ts 文件，用于初始化 OpenTelemetry 并注册 LangfuseSpanProcessor：

        ```typescript
        import { NodeSDK } from "@opentelemetry/sdk-node";
        import { LangfuseSpanProcessor } from "@langfuse/otel"; 
        
        const sdk = new NodeSDK({
          spanProcessors: [new LangfuseSpanProcessor()],
        });
        
        sdk.start();
        ```

    3. 在应用的入口文件中引入：

        ```typescript
        import "./instrumentation"; // 必须在所有导入之前加载
        ```

4. 为应用添加追踪逻辑。

    ```typescript
    import { startActiveObservation, startObservation } from "@langfuse/tracing";

    await startActiveObservation("user-request", async (span) => {
      span.update({
        input: { query: "What is the capital of France?" },
      });

      // 创建子代生成任务
      const generation = startObservation(
        "llm-call",
        {
          model: "gpt-4",
          input: [{ role: "user", content: "What is the capital of France?" }],
        },
        { asType: "generation" },
      );

      // 模型推理逻辑
      generation
        .update({
          output: { content: "The capital of France is Paris." },
        })
        .end();

      span.update({ output: "Successfully answered." });
    });
    ```

### 查看 Trace 数据
运行您的应用后，您可以在 PowerRAG 控制台的可观测性（Observability）模块中查看刚刚生成的 Trace。系统会以图形化方式展示调用链结构、每个节点的耗时、输入输出内容及成本统计，帮助您快速了解模型调用的执行细节与性能表现。

