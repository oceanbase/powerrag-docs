# Metadata

In the observability system, metadata can be added to traces and observations to help you better understand user, application, and experiment behavior. Metadata is added to traces in arbitrary JSON format to supplement contextual information. When metadata is updated, it is merged based on top-level keys. It is recommended to avoid writing to the same key multiple times in instrumentation logic, as this may lead to indeterminate behavior.

## How to use

### Python SDK

+ Adding metadata using the @observe() decorator

```python
from langfuse import observe, get_client

langfuse = get_client()

@observe()
def process_data():
    # Get client instance, update current trace metadata

    # Add metadata at trace level
    langfuse.update_current_trace(
        metadata={"source": "api", "version": "1.2.3"}
    )

    # Add metadata at current span level
    langfuse.update_current_span(
        metadata={"processing_stage": "initial"}
    )

    # Data processing logic...
    return result
```

+ Directly creating a span and adding metadata

```python
from langfuse import get_client

langfuse = get_client()

# Add metadata at trace level
with langfuse.start_as_current_span(
    name="process-request"
) as root_span:
    # Add metadata to trace
    root_span.update_trace(metadata={"request_id": "req_12345"})

    # Add metadata to current span
    root_span.update(metadata={"stage": "parsing"})

    # Create child span with metadata
    with root_span.start_as_current_generation(
        name="generate-response",
        model="gpt-4o",
        metadata={"temperature": 0.7, "max_tokens": 1000}
    ) as gen:
        # Update metadata later if needed
        gen.update(metadata={"completion_type": "creative"})
```

+ Updating entity multiple times to add new metadata keys

> Notice
> It is recommended not to write to the same top-level key repeatedly, as this may produce indeterminate results.

```python
with langfuse.start_as_current_span(name="operation") as span:
# First write
span.update(metadata={"status": "started"})

# Add new key, will merge with previous metadata
span.update(metadata={"error": "Failed to process"})

# Final metadata will be {"status": "started", "error": "Failed to process"}
```

### JS/TS SDK

+ Adding metadata using context managers

```typescript
import {
  startActiveObservation,
  startObservation,
  updateActiveTrace,
} from "@langfuse/tracing";

await startActiveObservation("context-manager", async (span) => {
  // Add metadata to observation
  span.update({
    input: { query: "What is the capital of France?" },
  });

  // Add metadata to trace
  updateActiveTrace({
    metadata: { key: "value" },
  });
});
```

+ Adding metadata using observe wrapper

```typescript
import {
  observe,
  updateActiveTrace,
  updateActiveObservation,
} from "@langfuse/tracing";

// Existing function
async function fetchData(source: string) {
  // Add metadata to observation
  updateActiveObservation({
    metadata: { key: "value" },
  });

  // Add metadata to trace
  updateActiveTrace({
    metadata: { key: "value" },
  });

  // ... data fetching logic
  return { data: `some data from ${source}` };
}

// Use observe wrapper function for tracing
const tracedFetchData = observe(fetchData, {
  name: "observe-wrapper",
});

const result = await tracedFetchData("API");
```

+ Manually creating a span and adding metadata

```typescript
import { startObservation } from "@langfuse/tracing";

const span = startObservation("manual-observation", {
  input: { query: "What is the capital of France?" },
  metadata: { key: "value" },
});

span.updateTrace({
  metadata: { key: "value" },
});

span.update({ output: "Paris" }).end();
```

