# 部署 Bridge 服务

Bridge 服务是连接 PowerRAG 平台与 Langfuse 服务的中间层，用于在二者之间传递观测与评测数据（通过 SDK/API）。  
部署 Bridge 服务后，用户即可在 PowerRAG 控制台中使用 **应用评测** 和 **应用观测** 功能。

## 前提条件
在部署 Bridge 服务前，请确保已完成以下操作：

+ 已部署并验证 Langfuse 服务正常运行。
+ 已在 Langfuse 控制台中创建并保存 **Public Key** 与 **Secret Key**。
+ 拥有可访问 Langfuse 的网络环境。

### 系统要求
#### 硬件要求
| **资源** | **最低配置** |
| --- | --- |
| CPU | 2 核 |
| 内存 | 4 GB（推荐 8 GB） |
| 存储 | 10 GB 可用空间 |
| 网络 | 稳定连接 |


#### 软件要求
| **组件** | **版本要求** |
| --- | --- |
| 操作系统 | Linux (推荐 Ubuntu 20.04+) |
| Docker | 20.10+ |
| Docker Compose | 2.0+ |
| Python | 3.11+（如使用直接运行模式） |


## 环境准备
1. 安装 Docker 和 Docker Compose。

    ```bash
    # Ubuntu/Debian
    sudo apt update
    sudo apt install docker.io docker-compose-plugin

    # 启动Docker服务
    sudo systemctl start docker
    sudo systemctl enable docker

    # 将用户添加到docker组
    sudo usermod -aG docker $USER
    newgrp docker
    ```

2. 导出镜像输出部署包。

    ```bash
    # 使用默认版本号（从.env文件读取IMAGE_TAG）
    ./export-images.sh

    # 指定版本号
    ./export-images.sh v1.2.3
    ```

    输出部署包内容如下：

    ```bash
    langfuse-bridge-delivery-[版本号]/
    ├── docker-compose.yml              # Docker Compose 配置
    ├── env.template                    # 环境变量模板
    ├── deploy.sh                       # 部署脚本
    ├── Dockerfile.minimal              # Docker 构建文件
    ├── 客户使用说明.md                 # 客户使用说明
    ├── README.md                       # 项目说明
    ├── QUICK_START.md                  # 快速开始指南
    ├── DOCKER_DEPLOYMENT.md            # Docker 部署文档
    ├── langfuse-bridge-image.tar.gz    # Docker 镜像文件（如果存在）
    ├── VERSION                         # 版本信息
    └── FILES.txt                       # 文件清单
    ```

## 部署服务

Bridge 提供两种部署方式：
+ 通过源码构建
+ 从仓库拉取镜像部署

### 方式一：通过源码构建

```bash
# 1. 构建镜像
./deploy.sh build

# 2. 启动服务
./deploy.sh start

# 3. 测试完成后推送镜像
./deploy.sh upload

```

### 方式二：从仓库拉取镜像部署

1. 在 .env 里配置镜像仓库用户名和密码，从仓库 harbor.oceanbase-dev.com，项目 powerrag 拉取镜像。

    ```bash
    HARBOR_USERNAME=your_harbor_username
    HARBOR_PASSWORD=your_harbor_password
    HARBOR_REGISTRY=your_harbor_host
    ```

2. 执行部署命令。

    ```bash
    # 从 Harbor 仓库拉取镜像并部署
    ./deploy.sh start-with-pull

    # 从 Harbor 仓库拉取镜像部署并重启
    ./deploy.sh restart-with-pull
    ```

## 配置远程跑测触发器
在使用从 Langfuse 控制台触发 SDK 跑测功能前，需要配置远程跑测触发器。具体功能和配置方法请参见 [通过 SDK 跑测](../40.应用评估/20.跑测/30.通过控制台跑测.md) 的“配置 Webhook”章节。

在配置远程跑测触发器时，需要配置以下信息：

+ Webhook URL：`http://<部署的Bridge服务host>:9002/webhook/dataset/process-items`。将 `<部署的Bridge服务host>` 替换为实际的 Bridge 服务主机地址。
+ 默认 Payload 配置：参考 [Bridge Payload 配置文档](https://github.com/oceanbase/langfuse/blob/main/BRIDGE-PAYLOAD.md#bridge-payload-%E9%85%8D%E7%BD%AE) 了解完整的 payload 配置说明。

## 运维与监控
### 健康检查
```bash
# 检查服务状态
curl http://localhost:9002/webhook/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2025-01-XX TXX:XX:XXZ",
  "version": "1.0.0"
}
```

### 日志管理
```bash
# 实时查看日志
docker-compose logs -f langfuse-bridge

# 查看最近100行日志
docker-compose logs --tail=100 langfuse-bridge

# 查看特定时间段的日志
docker-compose logs --since="2025-01-01T00:00:00" langfuse-bridge

# 查看错误日志
docker-compose logs langfuse-bridge | grep ERROR
```

### 性能监控
```bash
# 查看容器资源使用
docker stats langfuse-bridge

# 查看容器详细信息
docker inspect langfuse-bridge

# 查看端口占用
netstat -tlnp | grep 9002
```

## 故障排查
### 常见问题
1. 容器启动失败。

    ```bash
    # 查看启动日志
    docker-compose logs langfuse-bridge

    # 检查环境变量
    docker-compose config

    # 检查端口占用
    netstat -tlnp | grep 9002

    # 检查Docker服务状态
    systemctl status docker
    ```

2. 内存不足。

    ```bash
    # 查看内存使用
    free -h
    docker stats langfuse-bridge

    # 调整内存限制
    # 编辑docker-compose.yml
    deploy:
    resources:
        limits:
        memory: 2G
        reservations:
        memory: 1G
    ```

3. 网络连接问题。

    ```bash
    # 测试网络连接
    curl -v http://localhost:9002/webhook/health

    # 检查防火墙
    sudo ufw status
    sudo firewall-cmd --list-ports

    # 检查DNS解析
    nslookup cloud.langfuse.com
    ```

4. 超时错误。

    ```bash
    # 增加超时时间
    export LANGFUSE_TIMEOUT=600
    export POWERRAG_TIMEOUT=1200
    docker-compose restart
    ```

### 调试模式
```bash
# 启用调试模式
export DEBUG=true
export LOG_LEVEL=DEBUG
docker-compose up

# 进入容器调试
docker-compose exec langfuse-bridge bash
```

### 性能优化
1. 并发配置优化

    ```bash
    # 根据服务器性能调整
    # CPU核心数 * 2
    export MAX_CONCURRENT=8

    # 评估器并发控制
    export EVALUATOR_BATCH_SIZE=2
    export EVALUATOR_MAX_CONCURRENT=2
    export EVALUATOR_REQUEST_DELAY=15.0
    ```

2. 内存优化

    ```bash
    # 设置内存安全参数
    export PYTHONHASHSEED=0
    export PYTHONUNBUFFERED=1
    export PYTHONMALLOC=malloc
    export MALLOC_CHECK_=0
    export PYTHONGC=1
    ```

3. 网络优化

    ```bash
    # 调整超时配置
    export LANGFUSE_TIMEOUT=60    # 网络良好时
    export POWERRAG_TIMEOUT=300  # 网络良好时
    export OTLP_TIMEOUT=60
    ```

4. 日志优化

    ```yaml
    # docker-compose.yml
    services:
    langfuse-bridge:
        logging:
        driver: "json-file"
        options:
            max-size: "10m"
            max-file: "3"
    ```

5. 资源限制

    ```yaml
    # docker-compose.yml
    services:
    langfuse-bridge:
        deploy:
        resources:
            limits:
            memory: 4G
            cpus: '2.0'
            reservations:
            memory: 2G
            cpus: '1.0'
    ```

